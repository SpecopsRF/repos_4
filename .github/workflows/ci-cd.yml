# ============================================
# CI/CD Pipeline Ð´Ð»Ñ Crypto Tracker
# ============================================
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ push Ð¸ pull request Ð² main
# ============================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE: crypto-tracker
  PYTHON_VERSION: "3.12"

jobs:
  # ----- Job 1: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ -----
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ï¿½ï¿½ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ§ª Run tests with coverage
        run: |
          pytest -v --cov=app --cov-report=xml --cov-report=term-missing
      
      - name: ðŸ“Š Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # ----- Job 2: Security Scanning -----
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ï¿½ï¿½ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Install Bandit
        run: pip install bandit
      
      - name: ðŸ” Run Bandit security scan
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -f txt
      
      - name: ðŸ“Š Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json

  # ----- Job 3: Code Quality -----
  lint:
    name: ðŸŽ¨ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Install linters
        run: |
          pip install flake8 black isort
      
      - name: ðŸŽ¨ Check code formatting with Black
        run: |
          black --check --diff app/ tests/ || echo "âš ï¸ Code formatting issues found"
      
      - name: ðŸ“‹ Check imports with isort
        run: |
          isort --check-only --diff app/ tests/ || echo "âš ï¸ Import sorting issues found"
      
      - name: ðŸ” Run Flake8
        run: |
          flake8 app/ tests/ --max-line-length=100 --ignore=E501,W503 || echo "âš ï¸ Linting issues found"

  # ----- Job 4: Build Docker Image -----
  build:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, security]  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð² Ð¸ security scan
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max     
  # ----- Job 5: Summary -----
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [test, security, lint, build]
    if: always()
    
    steps:
      - name: ðŸ“‹ Create summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ï¿½ï¿½ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
